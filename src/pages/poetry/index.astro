---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const base = import.meta.env.BASE_URL.replace(/\/$/, '');

const poems = (await getCollection('writing', ({ data }) => data.published && data.genre === 'poetry'))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const allTags = [...new Set(poems.flatMap((p) => p.data.tags))].sort();

const formatDate = (d: Date) => d.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'short',
  day: 'numeric',
});
---

<BaseLayout title="Poetry â€” Audrey Evergreene">
  <h1 class="text-3xl font-bold mb-8">Poetry</h1>

  {poems.length === 0 ? (
    <p class="text-text-secondary">
      No poems yet. They'll arrive when the words are ready.
    </p>
  ) : (
    <div>
      <!-- Search & filter -->
      <div class="mb-6 space-y-3">
        <input
          type="text"
          id="poem-search"
          placeholder="Search poems..."
          class="w-full px-4 py-2 rounded-lg border border-border bg-surface text-text placeholder:text-text-muted focus:outline-none focus:border-accent transition-colors"
        />
        {allTags.length > 1 && (
          <div class="flex flex-wrap gap-2" id="filter-tags">
            {allTags.map((tag) => (
              <button
                data-filter-tag={tag}
                class="filter-btn px-3 py-1 text-xs rounded-full border border-border text-text-muted hover:border-accent hover:text-accent transition-colors"
              >
                {tag}
              </button>
            ))}
          </div>
        )}
      </div>

      <!-- Poem cards -->
      <div class="grid gap-4" id="poem-list">
        {poems.map((poem) => (
          <a
            href={`${base}/writing/${poem.slug}/`}
            class="poem-card group block p-5 rounded-lg border border-border hover:border-accent transition-colors"
            data-title={poem.data.title.toLowerCase()}
            data-tags={JSON.stringify(poem.data.tags)}
            data-body={poem.body?.toLowerCase() ?? ''}
          >
            <h3 class="text-lg font-semibold group-hover:text-accent transition-colors">
              {poem.data.title}
            </h3>
            {poem.data.description && (
              <p class="mt-2 text-sm text-text-secondary line-clamp-2">
                {poem.data.description}
              </p>
            )}
            <div class="mt-3 flex flex-wrap items-center gap-3">
              <time class="text-xs text-text-muted" datetime={poem.data.date.toISOString()}>
                {formatDate(poem.data.date)}
              </time>
              {poem.data.tags.length > 0 && poem.data.tags.slice(0, 3).map((tag) => (
                <span class="text-xs px-2 py-0.5 rounded-full bg-tag-bg text-tag-text">
                  {tag}
                </span>
              ))}
            </div>
          </a>
        ))}
      </div>

      <!-- No results message -->
      <p id="no-results" class="hidden text-text-muted py-4">No poems match your search.</p>
    </div>
  )}
</BaseLayout>

<script>
  const searchInput = document.getElementById('poem-search') as HTMLInputElement;
  const noResults = document.getElementById('no-results');
  let activeFilters: Set<string> = new Set();

  function applyFilters() {
    const query = searchInput?.value.toLowerCase() ?? '';
    const cards = document.querySelectorAll('.poem-card');
    let visibleCount = 0;

    cards.forEach((card) => {
      const el = card as HTMLElement;
      const title = el.dataset.title ?? '';
      const body = el.dataset.body ?? '';
      const tags: string[] = JSON.parse(el.dataset.tags ?? '[]');

      const searchable = [title, body, ...tags.map((t) => t.toLowerCase())];
      const matchesSearch = !query || searchable.some((s) => s.includes(query));
      const matchesFilters = activeFilters.size === 0 || [...activeFilters].every((f) =>
        tags.map((t) => t.toLowerCase()).includes(f.toLowerCase())
      );

      const visible = matchesSearch && matchesFilters;
      el.classList.toggle('hidden', !visible);
      if (visible) visibleCount++;
    });

    noResults?.classList.toggle('hidden', visibleCount > 0);
  }

  searchInput?.addEventListener('input', applyFilters);

  document.querySelectorAll('.filter-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const el = btn as HTMLElement;
      const value = el.dataset.filterTag ?? '';
      if (activeFilters.has(value)) {
        activeFilters.delete(value);
        el.classList.remove('bg-accent', 'text-bg', 'border-accent');
      } else {
        activeFilters.add(value);
        el.classList.add('bg-accent', 'text-bg', 'border-accent');
      }
      applyFilters();
    });
  });
</script>
